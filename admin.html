<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Pamy's</title>
    <link href="https://fonts.googleapis.com/css2?family=Epunda+Slab:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        .panel-section { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .section-title { color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .panel-grid { display: flex; gap: 20px; flex-wrap: wrap; }
        .panel-box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .box-form { flex: 1; min-width: 300px; }
        .box-list { flex: 2; min-width: 300px; }
        .item-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0; }
        .btn-delete { color: red; cursor: pointer; background: none; border: none; }
        .coupon-tag { background: #fff3e0; color: #e65100; padding: 3px 8px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

    <header class="header-logo">
    <div class="brand" style="color:white; font-size:1.5rem;">Admin Pamy's</div>
    <nav>
        <button onclick="window.location.href='index.html'">Ver Tienda</button>
        <button onclick="cerrarSesion()" style="background: #d32f2f; margin-left: 10px;">
            <i class="fas fa-sign-out-alt"></i> Salir
        </button>
    </nav>
</header>

<div class="panel-box box-form">
    <h3 id="form-title">Nuevo Producto</h3> <input id="p-name" class="form-input" placeholder="Nombre">
    <input id="p-price" type="number" class="form-input" placeholder="Precio">
    <select id="p-cat" class="form-input">
        <option value="menu">Menú</option>
        <option value="promocion">Promoción</option>
    </select>
    <textarea id="p-desc" class="form-input" rows="2" placeholder="Descripción"></textarea>
    <input id="p-img" class="form-input" placeholder="URL Imagen">
    
    <div style="display: flex; gap: 10px;">
        <button id="btn-save" class="btn-add" onclick="guardarProducto()" style="flex: 1;">Guardar</button>
        <button id="btn-cancel" onclick="cancelarEdicion()" style="background: #777; color: white; border:none; border-radius:4px; display: none;">Cancelar</button>
    </div>
</div>

    <div class="panel-section">
        <h2 class="section-title">Gestión de Cupones</h2>
        <div class="panel-grid">
    
    <div class="panel-box box-form">
        <h3 id="form-title" class="section-title">Nuevo Producto</h3>
        
        <input id="p-name" class="form-input" placeholder="Nombre">
        <input id="p-price" type="number" class="form-input" placeholder="Precio">
        <select id="p-cat" class="form-input">
            <option value="menu">Menú</option>
            <option value="promocion">Promoción</option>
        </select>
        <textarea id="p-desc" class="form-input" rows="2" placeholder="Descripción"></textarea>
        <input id="p-img" class="form-input" placeholder="URL Imagen">

        <div style="display: flex; gap: 10px;">
            <button id="btn-save" class="btn-add" onclick="guardarProducto()" style="flex: 1;">Guardar</button>
            <button id="btn-cancel" onclick="cancelarEdicion()" style="background: #777; color: white; border:none; border-radius:4px; padding: 0 15px; display: none;">Cancelar</button>
        </div>
    </div>

    <div class="panel-box box-list">
        <h3 class="section-title">Inventario Actual</h3>
        <div id="lista-productos">
            <p style="color:#777">Cargando productos...</p>
        </div>
    </div>

</div>
    </div>

    <script>
       // VARIABLES GLOBALES
    let inventarioActual = []; 
    let idEnEdicion = null; // Si es null, estamos creando. Si tiene ID, estamos editando.

    // PRODUCTOS
    async function cargarProductos() {
        const res = await fetch(API + '/products');
        inventarioActual = await res.json(); // Guardamos en memoria
        
        const div = document.getElementById('lista-productos');
        div.innerHTML = '';
        
        inventarioActual.forEach(p => {
            // Agregamos botón de Lápiz (Editar)
            div.innerHTML += `
            <div class="item-row">
                <div><b>${p.nombre}</b> ($${p.precio})</div>
                <div>
                    <button class="btn-delete" style="color:var(--primary); margin-right:10px;" onclick="prepararEdicion('${p._id}')">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                    <button class="btn-delete" onclick="borrarP('${p._id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>`;
        });
    }

    function prepararEdicion(id) {
        const producto = inventarioActual.find(p => p._id === id);
        if(!producto) return;

        // Rellenar formulario
        document.getElementById('p-name').value = producto.nombre;
        document.getElementById('p-price').value = producto.precio;
        document.getElementById('p-cat').value = producto.categoria;
        document.getElementById('p-desc').value = producto.desc;
        document.getElementById('p-img').value = producto.img;

        // Cambiar estado visual
        idEnEdicion = id;
        document.getElementById('form-title').innerText = "Editando Producto";
        document.getElementById('btn-save').innerText = "Actualizar";
        document.getElementById('btn-save').style.background = "#ff9800"; // Naranja para editar
        document.getElementById('btn-cancel').style.display = "block";
    }

    function cancelarEdicion() {
        idEnEdicion = null;
        document.getElementById('p-name').value = '';
        document.getElementById('p-price').value = '';
        document.getElementById('p-desc').value = '';
        document.getElementById('p-img').value = '';
        
        document.getElementById('form-title').innerText = "Nuevo Producto";
        document.getElementById('btn-save').innerText = "Guardar";
        document.getElementById('btn-save').style.background = ""; // Color original
        document.getElementById('btn-cancel').style.display = "none";
    }

    async function guardarProducto() {
        const data = {
            nombre: document.getElementById('p-name').value,
            precio: document.getElementById('p-price').value,
            categoria: document.getElementById('p-cat').value,
            desc: document.getElementById('p-desc').value,
            img: document.getElementById('p-img').value
        };
        if(!data.nombre) return alert("Falta nombre");

        if (idEnEdicion) {
            // MODO EDICIÓN (PUT)
            await fetch(API + `/products/${idEnEdicion}`, { 
                method: 'PUT', 
                headers:{'Content-Type':'application/json'}, 
                body: JSON.stringify(data)
            });
            alert("Producto actualizado");
        } else {
            // MODO CREACIÓN (POST)
            await fetch(API + '/products', { 
                method: 'POST', 
                headers:{'Content-Type':'application/json'}, 
                body: JSON.stringify(data)
            });
        }

        cancelarEdicion(); // Limpia y resetea botones
        cargarProductos(); // Recarga la lista
    }

    // LOGOUT
    function cerrarSesion() {
        if(confirm("¿Cerrar sesión?")) {
            localStorage.removeItem('role'); // Borramos credenciales
            localStorage.removeItem('token'); 
            window.location.href = 'index.html'; // Redirige al inicio
        }
    }
    </script>
</body>

</html>



